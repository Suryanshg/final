<!DOCTYPE html>

<script src="https://d3js.org/d3.v6.min.js"></script>

<html>
    <style>

        .tooltip {
          position: absolute;
          /*font-size: 20px;*/
          /*pointer-events: none;*/
          background-color: #111;
          visibility: hidden;
          display: flex;
          font-family: sans-serif;
          max-width: 500px;
          color: white;
      }
      
      </style>

        <div id="lolChart"></div>

</html>

<script>
    //console.log(d3);

    // setting the dimensions and margins of the bar chart
    var margin = {top: 30, right: 30, bottom: 80, left: 80},
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;


    // appending the svg 
    var svg = d3.select("#lolChart")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
            // adjusting the position of svg
      .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    // Tool tip
    var tooltip = d3.select("#lolChart") 
        .append("div")
        //.style("opacity", 0)
        .attr("class", "tooltip")


    //svg.append("g")
    //.attr("transform",
    //      "translate(" + margin.left + "," + margin.top + ")");

    let testData = [
        {name: 'first', val: 1},
        {name: 'second', val: 2},
        {name: 'third', val: 3},
        {name: 'fourth', val: 4},
        {name: 'fifth', val: 5},
    ];

    d3.tsv("master.tsv").then(function(data) {

        var targetDrug = "17-hydroxyprogesterone" // level 3

        // Converting the string fields to numeric vals
        data.forEach(function(d) {
            d.MeanFrequency = +d.MeanFrequency;
            d.MinFrequency = +d.MinFrequency;
            d.MaxFrequency = +d.MaxFrequency;
          })

         // Filtering by drug - level 3
         var filteredSideEffects = data.filter(d => d.Name == targetDrug)

         filteredSideEffects.sort(function(a, b) {
           return b.MeanFrequency - a.MeanFrequency
         })
       
         filteredSideEffects = filteredSideEffects.slice(0,20)
         console.log(filteredSideEffects)   // Top 20 side effects of the target Drug



        function activateThirdLevel() {
            console.log("going to the next level!");
        }

        function createChart(data) {

            let xScale = d3.scaleBand()
            .range([0, width])
            .domain(data.map(function(d){ return d.SideEffectName}))
            .padding(0.2)

            let yScale = d3.scaleLinear()
            .domain([0, 1])
            .range([height, 0]);

            //create x axis
            svg.append('g')
            .attr('transform', `translate(${0}, ${height})`)
            .call(d3.axisBottom(xScale))
            .selectAll("text")
            .attr("transform", "translate(0,0)rotate(-45)")
            .style("text-anchor", "end");

            //create y axis
            svg.append('g')
            //.attr('transform', `translate(${margin.left}, ${margin.top})`)
            .call(d3.axisLeft(yScale));

            svg.selectAll('lolLine')
            .data(data)
            .enter()
            .append('line')
            .attr("x1", d => { return xScale(d.SideEffectName)  + xScale.bandwidth()/2 })
            .attr("x2", d => { return xScale(d.SideEffectName)  + xScale.bandwidth()/2 })
            .attr("y1", d => { return yScale(d.MaxFrequency); })
            .attr("y2", d => { return yScale(d.MinFrequency); })
            .attr('stroke', 'grey')
        
            svg.selectAll('lolCircle1') // upper circle for upper limit
            .data(data)
            .enter()
            .append('circle')
            .attr('cx', d => xScale(d.SideEffectName) + xScale.bandwidth()/2)
            .attr('cy', d => yScale(d.MaxFrequency))
            .attr('r', 5)
            .style('fill', 'steelblue')
            .attr('stroke', 'black')
            .style('cursor', 'pointer')
            .on('mouseover', (event, d) => {
                d3.select(event.target).attr('opacity', 0.4)
                tooltip.text(d.Name)
                .style("left", (event.pageX) + "px")
                .style("top", (event.pageY - 30) + "px")
                .transition()
                .duration(200)
                .style('visibility','visible')
            })
            .on('mouseout', (event, d) => {
                d3.select(event.target).attr('opacity', 1)
                tooltip.style('visibility','hidden')
            })
            .on('mousedown', (event, d) => {
                activateThirdLevel();
            })
        
            svg.selectAll('lolCircle2') // lower circle for lower limit
            .data(data)
            .enter()
            .append('circle')
                .attr('cx', d => xScale(d.SideEffectName) + xScale.bandwidth()/2 )
                .attr('cy', d => yScale(d.MinFrequency))
                .attr('r', 5)
                .style('fill', 'steelblue')
                .attr('stroke', 'black')
                .style('cursor', 'pointer')
                .on('mouseover', (event, d) => {
                    d3.select(event.target).attr('opacity', 0.4)
                    tooltip.text(d.Name)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 30) + "px")
                    .transition()
                    .duration(200)
                    .style('visibility','visible')
                })
                .on('mouseout', (event, d) => {
                    d3.select(event.target).attr('opacity', 1)
                    tooltip.style('visibility','hidden')
                })
                .on('mousedown', (event, d) => {
                    activateThirdLevel();
                })

        }

    createChart(filteredSideEffects);


    })


</script>

<style></style>