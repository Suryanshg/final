<!DOCTYPE html>

<script src="https://d3js.org/d3.v6.min.js"></script>



<html>
    <head>
		<link rel="stylesheet" href="styles.css" />
	</head>
    <div id="lolChart">
        <div class="lolToolTip"></div>
    </div>
    <!-- <style>

        .lolToolTip {
          position: absolute;
          /*font-size: 20px;*/
          /*pointer-events: none;*/
          background-color: #111;
          visibility: hidden;
          display: flex;
          font-family: sans-serif;
          max-width: 500px;
          color: white;
          padding: 4px;
      }
      
      </style> -->
</html>

<script>
    //console.log(d3);

    // setting the dimensions and margins of the bar chart
    var margin = {top: 30, right: 30, bottom: 80, left: 80},
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;


    // appending the svg 
    var svg = d3.select("#lolChart")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
            // adjusting the position of svg
      .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    // Tool tip
    var tooltip = d3.select(".lolToolTip") 
        //.append("div")
        //.style("opacity", 0)
        //.attr("class", "tooltip")


    function activateSecondLevel(newSideEffect) {
        console.log("Second Level: Change the global variable for target side effect to ",newSideEffect);
    }

    function createLolChart(drug) {
        d3.tsv("master.tsv").then(function(masterData) {
            var targetDrug = drug // level 3
        
            // Converting the string fields to numeric vals
            masterData.forEach(function(d) {
                d.MeanFrequency = +d.MeanFrequency;
                d.MinFrequency = +d.MinFrequency;
                d.MaxFrequency = +d.MaxFrequency;
            })
        
            // Filtering by drug - level 3
            var filteredSideEffects = masterData.filter(d => d.Name == targetDrug)
        
            filteredSideEffects.sort(function(a, b) {
                return b.MeanFrequency - a.MeanFrequency
            })
               
            filteredSideEffects = filteredSideEffects.slice(0,20)
            console.log(filteredSideEffects)   // Top 20 side effects of the target Drug

            data = filteredSideEffects

            let xScale = d3.scaleBand()
            .range([0, width])
            .domain(data.map(function(d){ return d.SideEffectName}))
            .padding(0.2)

            let yScale = d3.scaleLinear()
            .domain([0, 1])
            .range([height, 0]);

            //create x axis
            svg.append('g')
            .attr('transform', `translate(${0}, ${height})`)
            .call(d3.axisBottom(xScale))
            .selectAll("text")
            .attr("transform", "translate(0,0)rotate(-45)")
            .style("text-anchor", "end");

            //create y axis
            svg.append('g')
            //.attr('transform', `translate(${margin.left}, ${margin.top})`)
            .call(d3.axisLeft(yScale))
            .selectAll("text")
            .attr("transform", "translate(-5,0)rotate(0)")
            .style("text-anchor", "end");

            svg.selectAll('lolLine')
            .data(data)
            .enter()
            .append('line')
            .attr("x1", d => { return xScale(d.SideEffectName)  + xScale.bandwidth()/2 })
            .attr("x2", d => { return xScale(d.SideEffectName)  + xScale.bandwidth()/2 })
            .attr("y1", d => { return yScale(d.MaxFrequency); })
            .attr("y2", d => { return yScale(d.MinFrequency); })
            .attr('stroke', 'black')
        
            svg.selectAll('lolCircle1') // upper circle for upper limit
            .data(data)
            .enter()
            .append('circle')
            .attr('cx', d => xScale(d.SideEffectName) + xScale.bandwidth()/2)
            .attr('cy', d => yScale(d.MaxFrequency))
            .attr('r', 5)
            .style('fill', 'steelblue')
            .attr('stroke', 'black')
            .style('cursor', 'pointer')
            .on('mouseover', (event, d) => {
                d3.select(event.target).attr('opacity', 0.4)
                tooltip.text(d.SideEffectName)
                .style("left", (event.pageX) + "px")
                .style("top", (event.pageY - 30) + "px")
                .transition()
                .duration(200)
                .style('visibility','visible')
            })
            .on('mouseout', (event, d) => {
                d3.select(event.target).attr('opacity', 1)
                tooltip.style('visibility','hidden')
            })
            .on('mousedown', (event, d) => {
                activateSecondLevel(d.SideEffectName);
            })
        
            svg.selectAll('lolCircle2') // lower circle for lower limit
            .data(data)
            .enter()
            .append('circle')
                .attr('cx', d => xScale(d.SideEffectName) + xScale.bandwidth()/2 )
                .attr('cy', d => yScale(d.MinFrequency))
                .attr('r', 5)
                .style('fill', 'steelblue')
                .attr('stroke', 'black')
                .style('cursor', 'pointer')
                .on('mouseover', (event, d) => {
                    d3.select(event.target).attr('opacity', 0.4)
                    tooltip.text(d.SideEffectName)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 30) + "px")
                    .transition()
                    .duration(200)
                    .style('visibility','visible')
                })
                .on('mouseout', (event, d) => {
                    d3.select(event.target).attr('opacity', 1)
                    tooltip.style('visibility','hidden')
                })
                .on('mousedown', (event, d) => {
                    activateSecondLevel(d.SideEffectName);
                })

        })

            
    
    }

    var currentDrug = "17-hydroxyprogesterone"
    createLolChart(currentDrug);




</script>

