<!DOCTYPE html>
<meta charset="utf-8">

<script src="https://d3js.org/d3.v6.min.js"></script>

<html>
  <head>
		<link rel="stylesheet" href="styles.css" />
	</head>
  <div id="barChart">
    <div class="bcToolTip"></div>
  </div>
  
  <!-- <style>
  
    .bcToolTip {
      position: absolute;
      /*font-size: 20px;*/
      /*pointer-events: none;*/
      background-color: #111;
      visibility: hidden;
      display: flex;
      font-family: sans-serif;
      max-width: 500px;
      color: white;
      padding: 4px;
  }
  
  </style> -->

</html>

<script>


    // setting the dimensions and margins of the bar chart
    var margin = {top: 30, right: 30, bottom: 60, left: 60},
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;
    
    // appending the svg 
    var svg = d3.select("#barChart")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)

    // adjusting the position of svg
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

    // Tool tip
    var tooltip = d3.select(".bcToolTip") 
      //.append("div")
      //.style("opacity", 0)
      //.attr("class", "tooltip")
    
    // Function to make changes to third level
    function activateThirdLevel(newDrug){
      console.log("Third Level: Change the global variable for target drug to ",newDrug)
    }

    // Function to create a bar chart for a particular side effect
    function createBarChart(sideEffect){
          // parsing the data
          d3.tsv("master.tsv").then(function(data) {

         // Converting the string fields to numeric vals
        data.forEach(function(d) {
          d.MeanFrequency = +d.MeanFrequency;
          d.MinFrequency = +d.MinFrequency;
          d.MaxFrequency = +d.MaxFrequency;
        })

        var targetSideEffect = sideEffect // level 2

        // Filtering by side effect - level 2
        var filteredDrugs = data.filter(d => d.SideEffectName == targetSideEffect)

        filteredDrugs.sort(function(a, b) {
          return b.MeanFrequency - a.MeanFrequency
        })

        filteredDrugs = filteredDrugs.slice(0,20)

        console.log(filteredDrugs)
    
        // adding x-axis
        var x = d3.scaleBand()
        .range([ 0, width ])
        .domain(filteredDrugs.map(function(d) { return d.Name; }))
        .padding(0.2);
        svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x))
        .selectAll("text")
          .attr("transform", "translate(0,0)rotate(-45)")
          .style("text-anchor", "end");
    
        // adding y-axis
        var y = d3.scaleLinear()
        .domain([0, 1])
        .range([ height, 0]);
        svg.append("g")
        .call(d3.axisLeft(y))
        .selectAll("text")
          .attr("transform", "translate(-5,0)rotate(0)")
          //.attr("text-anchor","end")
    
        // add bars
        svg.selectAll("mybar")
        .data(filteredDrugs)
        .enter()
        .append("rect")
          .attr("x", function(d) { 
            return x(d.Name); 
          })
          .attr("y", function(d) { 
            return y(d.MeanFrequency); 
          })
          .attr("width", x.bandwidth())
          .attr("height", function(d) { return height - y(d.MeanFrequency); })
          .attr("fill", "steelblue")
          .attr('stroke',"black")
          .on("mouseover",function(e,d){
            d3.select(this)
            .attr('opacity',0.5)

            tooltip.text(d.Name)
            .style("left", (e.pageX) + "px")
            .style("top", (e.pageY - 30) + "px")
            .transition()
            .duration(200)
            .style('visibility','visible')
          })
          .on("mouseout",function(d){
            d3.select(this)
            .attr('opacity',1)

            tooltip.style('visibility','hidden')
          })
          .on("mousedown",function(e,d){
            activateThirdLevel(d.Name)
          })
    
    })

    }

    var sideEffect = "Depression"
    createBarChart(sideEffect)

    
    </script>


    <!-- Separate Script for testing and querying master data, no need to copy this -->
    <script>
      d3.tsv("master.tsv").then(function(data){

        var targetDrug = "18F-flutemetamol" // level 3
        var targetSideEffect = "Depression" // level 2
        
        // Converting the string fields to numeric vals
        data.forEach(function(d) {
          d.MeanFrequency = +d.MeanFrequency;
          d.MinFrequency = +d.MinFrequency;
          d.MaxFrequency = +d.MaxFrequency;
        })

        //console.log(data)

        // Filtering by drug - level 3
        var filteredSideEffects = data.filter(d => d.Name == targetDrug)

        filteredSideEffects.sort(function(a, b) {
          return b.MeanFrequency - a.MeanFrequency
        })
      
        filteredSideEffects = filteredSideEffects.slice(0,20)
        //console.log(filteredSideEffects)   // Top 20 side effects of the target Drug



        // Filtering by side effect - level 2
        var filteredDrugs = data.filter(d => d.SideEffectName == targetSideEffect)

        filteredDrugs.sort(function(a, b) {
          return b.MeanFrequency - a.MeanFrequency
        })

        filteredDrugs = filteredDrugs.slice(0,20)
        //console.log(filteredDrugs) // Top 20 drugs with target Side effect
      })
    </script>